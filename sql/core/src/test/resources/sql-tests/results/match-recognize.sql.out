-- Automatically generated by SQLQueryTestSuite
-- !query
CREATE TABLE stock_data (symbol STRING, ts BIGINT, price DECIMAL(10,2))
USING parquet
-- !query schema
struct<>
-- !query output



-- !query
INSERT INTO stock_data VALUES
  ('AAPL', 1, 100.00),
  ('AAPL', 2, 90.00),
  ('AAPL', 3, 110.00),
  ('GOOG', 1, 200.00),
  ('GOOG', 2, 180.00),
  ('GOOG', 3, 220.00),
  ('MSFT', 1, 50.00),
  ('MSFT', 2, 60.00),
  ('MSFT', 3, 55.00)
-- !query schema
struct<>
-- !query output



-- !query
SELECT * FROM stock_data
MATCH_RECOGNIZE (
  PARTITION BY symbol
  ORDER BY ts
  MEASURES
    symbol AS sym,
    LAST(A.ts) AS last_a_ts,
    LAST(ts) AS last_ts
  PATTERN (A B)
  DEFINE
    A AS ts = 1,
    B AS ts = 2
)
-- !query schema
struct<sym:string,last_a_ts:bigint,last_ts:bigint>
-- !query output
AAPL	1	2
GOOG	1	2
MSFT	1	2


-- !query
SELECT * FROM stock_data
MATCH_RECOGNIZE (
  ORDER BY ts
  MEASURES
    FIRST(ts) AS start_ts,
    LAST(ts) AS end_ts
  PATTERN (A B)
  DEFINE
    A AS ts = 1,
    B AS ts = 2
)
-- !query schema
struct<start_ts:bigint,end_ts:bigint>
-- !query output
1	2


-- !query
DROP TABLE stock_data
-- !query schema
struct<>
-- !query output



-- !query
CREATE TABLE test_shadow (ts BIGINT, price BIGINT) USING parquet
-- !query schema
struct<>
-- !query output



-- !query
INSERT INTO test_shadow VALUES (1, 100), (2, 100), (1, 200), (2, 200)
-- !query schema
struct<>
-- !query output



-- !query
SELECT * FROM test_shadow
MATCH_RECOGNIZE (
  PARTITION BY ts + 1 AS price
  ORDER BY ts
  MEASURES
    price AS partition_val
  PATTERN (A)
  DEFINE
    A AS ts > 0
)
-- !query schema
struct<partition_val:bigint>
-- !query output
2
2
3
3


-- !query
DROP TABLE test_shadow
-- !query schema
struct<>
-- !query output



-- !query
CREATE TABLE quant_test (ts BIGINT, price BIGINT) USING parquet
-- !query schema
struct<>
-- !query output



-- !query
INSERT INTO quant_test VALUES (1, 100), (2, 110), (3, 120), (4, 50)
-- !query schema
struct<>
-- !query output



-- !query
SELECT * FROM quant_test
MATCH_RECOGNIZE (
  ORDER BY ts
  MEASURES
    FIRST(ts) AS start_ts,
    LAST(ts) AS end_ts
  PATTERN (A+)
  DEFINE
    A AS price > 80
)
-- !query schema
struct<start_ts:bigint,end_ts:bigint>
-- !query output
1	3


-- !query
SELECT * FROM quant_test
MATCH_RECOGNIZE (
  ORDER BY ts
  MEASURES
    FIRST(ts) AS start_ts,
    LAST(ts) AS end_ts
  PATTERN (A+ B)
  DEFINE
    A AS price > 80,
    B AS price <= 80
)
-- !query schema
struct<start_ts:bigint,end_ts:bigint>
-- !query output
1	4


-- !query
DROP TABLE quant_test
-- !query schema
struct<>
-- !query output



-- !query
CREATE TABLE group_test (ts BIGINT, price BIGINT) USING parquet
-- !query schema
struct<>
-- !query output



-- !query
INSERT INTO group_test VALUES (1, 50), (2, 150), (3, 60), (4, 200), (5, 10)
-- !query schema
struct<>
-- !query output



-- !query
SELECT * FROM group_test
MATCH_RECOGNIZE (
  ORDER BY ts
  MEASURES
    FIRST(ts) AS start_ts,
    LAST(ts) AS end_ts
  PATTERN ((A B)+)
  DEFINE
    A AS price < 100,
    B AS price >= 100
)
-- !query schema
struct<start_ts:bigint,end_ts:bigint>
-- !query output
1	4


-- !query
SELECT * FROM group_test
MATCH_RECOGNIZE (
  ORDER BY ts
  MEASURES
    FIRST(ts) AS start_ts,
    LAST(ts) AS end_ts
  PATTERN ((A B)+ C)
  DEFINE
    A AS price < 100,
    B AS price >= 100,
    C AS price < 50
)
-- !query schema
struct<start_ts:bigint,end_ts:bigint>
-- !query output
1	5


-- !query
DROP TABLE group_test
-- !query schema
struct<>
-- !query output



-- !query
CREATE TABLE error_test (ts BIGINT, price DECIMAL(10,2)) USING parquet
-- !query schema
struct<>
-- !query output



-- !query
INSERT INTO error_test VALUES (1, 100.00)
-- !query schema
struct<>
-- !query output



-- !query
SELECT * FROM error_test
MATCH_RECOGNIZE (
  ORDER BY ts
  MEASURES LAST(ts) AS end_ts
  PATTERN (A | B)
  DEFINE
    A AS price > 50,
    B AS price > 100
)
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "UNSUPPORTED_FEATURE.MATCH_RECOGNIZE_ALTERNATION",
  "sqlState" : "0A000",
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 26,
    "stopIndex" : 157,
    "fragment" : "MATCH_RECOGNIZE (\n  ORDER BY ts\n  MEASURES LAST(ts) AS end_ts\n  PATTERN (A | B)\n  DEFINE\n    A AS price > 50,\n    B AS price > 100\n)"
  } ]
}


-- !query
DROP TABLE error_test
-- !query schema
struct<>
-- !query output



-- !query
CREATE TABLE error_test (ts BIGINT, price DECIMAL(10,2)) USING parquet
-- !query schema
struct<>
-- !query output



-- !query
INSERT INTO error_test VALUES (1, 100.00)
-- !query schema
struct<>
-- !query output



-- !query
SELECT * FROM error_test
MATCH_RECOGNIZE (
  ORDER BY ts
  MEASURES LAST(ts) AS end_ts
  PATTERN (A B)
  DEFINE
    A AS price > 50,
    A AS price > 100
)
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "DUPLICATE_PATTERN_VARIABLE",
  "sqlState" : "42710",
  "messageParameters" : {
    "variableName" : "`a`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 26,
    "stopIndex" : 155,
    "fragment" : "MATCH_RECOGNIZE (\n  ORDER BY ts\n  MEASURES LAST(ts) AS end_ts\n  PATTERN (A B)\n  DEFINE\n    A AS price > 50,\n    A AS price > 100\n)"
  } ]
}


-- !query
DROP TABLE error_test
-- !query schema
struct<>
-- !query output



-- !query
CREATE TABLE error_test (ts BIGINT, price DECIMAL(10,2)) USING parquet
-- !query schema
struct<>
-- !query output



-- !query
INSERT INTO error_test VALUES (1, 100.00)
-- !query schema
struct<>
-- !query output



-- !query
SELECT * FROM error_test
MATCH_RECOGNIZE (
  ORDER BY ts
  MEASURES LAST(ts) AS end_ts
  PATTERN (A B)
  DEFINE
    A AS price > 50
)
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "UNDEFINED_PATTERN_VARIABLE",
  "sqlState" : "42703",
  "messageParameters" : {
    "variableName" : "`b`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 26,
    "stopIndex" : 133,
    "fragment" : "MATCH_RECOGNIZE (\n  ORDER BY ts\n  MEASURES LAST(ts) AS end_ts\n  PATTERN (A B)\n  DEFINE\n    A AS price > 50\n)"
  } ]
}


-- !query
DROP TABLE error_test
-- !query schema
struct<>
-- !query output



-- !query
CREATE TABLE error_test (ts BIGINT, price DECIMAL(10,2)) USING parquet
-- !query schema
struct<>
-- !query output



-- !query
INSERT INTO error_test VALUES (1, 100.00)
-- !query schema
struct<>
-- !query output



-- !query
SELECT * FROM error_test
MATCH_RECOGNIZE (
  ORDER BY ts
  MEASURES LAST(A.price - B.price) AS price_diff
  PATTERN (A B)
  DEFINE
    A AS price > 50,
    B AS price > 100
)
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "MATCH_RECOGNIZE_AGGREGATE_MIXED_QUALIFIERS",
  "sqlState" : "42803",
  "messageParameters" : {
    "expression" : "last((price - price))",
    "qualifiers" : "a, b"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 26,
    "stopIndex" : 174,
    "fragment" : "MATCH_RECOGNIZE (\n  ORDER BY ts\n  MEASURES LAST(A.price - B.price) AS price_diff\n  PATTERN (A B)\n  DEFINE\n    A AS price > 50,\n    B AS price > 100\n)"
  } ]
}


-- !query
DROP TABLE error_test
-- !query schema
struct<>
-- !query output



-- !query
CREATE TABLE error_test (ts BIGINT, price DECIMAL(10,2)) USING parquet
-- !query schema
struct<>
-- !query output



-- !query
INSERT INTO error_test VALUES (1, 100.00)
-- !query schema
struct<>
-- !query output



-- !query
SELECT * FROM error_test
MATCH_RECOGNIZE (
  ORDER BY ts
  MEASURES LAST(ts) AS end_ts
  PATTERN (A B)
  DEFINE
    A AS price > RAND(),
    B AS price > 100
)
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "MATCH_RECOGNIZE_NONDETERMINISTIC_DEFINE",
  "sqlState" : "42845",
  "messageParameters" : {
    "expression" : "(price > rand())",
    "variableName" : "`a`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 26,
    "stopIndex" : 159,
    "fragment" : "MATCH_RECOGNIZE (\n  ORDER BY ts\n  MEASURES LAST(ts) AS end_ts\n  PATTERN (A B)\n  DEFINE\n    A AS price > RAND(),\n    B AS price > 100\n)"
  } ]
}


-- !query
DROP TABLE error_test
-- !query schema
struct<>
-- !query output

